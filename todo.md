# 音声日記アプリケーション TODO

## データベース・バックエンド
- [x] データベーススキーマの設計（録音履歴、Notion同期状態）
- [x] 音声ファイルをS3にアップロードするAPI
- [x] Whisper APIを使用した音声テキスト変換API
- [x] Notionデータベースへの自動保存API
- [x] 日記エントリー一覧取得API（Notionから取得）
- [x] エラーハンドリングとリトライロジック

## フロントエンド・デザイン
- [x] エディトリアルデザインシステムの構築（クリーム背景、Didoneセリフ体）
- [x] グローバルテーマとタイポグラフィの設定
- [x] ブラウザ音声録音機能の実装（MediaRecorder API）
- [x] 録音UI（開始/停止ボタン、録音時間表示）
- [x] 録音中の視覚的フィードバック（波形またはアニメーション）
- [x] タグ選択UI（複数選択可能なチェックボックス）
- [x] 日記エントリー一覧表示画面
- [x] ローディング状態とエラー通知の実装

## 統合・テスト
- [x] 音声録音→S3アップロード→テキスト変換→Notion保存の統合フロー
- [x] エラーケースのテスト（録音失敗、変換失敗、Notion保存失敗）
- [x] ブラウザ互換性テスト（Chrome、Safari、Firefox）
- [x] レスポンシブデザインの確認
- [x] Vitest単体テストの作成

## デプロイ・ドキュメント
- [x] チェックポイント作成
- [x] 使用方法ドキュメントの作成

## バグ修正
- [x] Notionタグプロパティの形式を修正（JSON文字列形式に変更）

## 新機能追加
- [x] LLMを使用した音声テキストの箇条書き整理機能
- [x] 整理されたテキストのプレビュー表示

## 高度な機能追加
- [x] 音声入力から日付を自動抽出する機能
- [x] 同じ日付の既存日記とマージする機能
- [x] 音声内容からタグを自動推測する機能
- [x] Notionから既存日記を検索・取得する機能

## バグ修正2
- [x] 日付解析エラーの修正（Invalid time value）

## バグ修正3
- [x] Notion更新API（notion-update-page）の引数形式を修正

## バグ修正4
- [x] シェルコマンドのエスケープ処理を修正（JSON入力の特殊文字対応）

## バグ修正5
- [x] 日付とタイトルの不一致を修正
- [x] LLMの応答から不要なヘッダー情報を除去

## バグ修正6
- [x] 日付抽出ロジックの抜本的見直し（LLMの日付抽出エラー対策）
- [x] タイトルと日付プロパティの完全同期
- [x] デバッグログの追加

## 機能改善
- [x] LLMによる日付抽出を復活させ、厳密な検証を追加
- [x] 日付の妥当性チェック（過去1年～未来1週間の範囲内）
- [x] 日付が不明確な場合のフォールバック処理

## アルゴリズム改善
- [x] LLMに日付の解釈のみを行わせ、具体的な日付または相対日数を返させる
- [x] プログラム側で日付計算を確実に実行
- [x] 日付の言及がない場合は現在日時を使用

## バグ修正7
- [x] 削除されたNotionページへの更新試行を防ぐエラーハンドリングを追加

## バグ修正8
- [x] 同じ日付で複数のレコードが作成される問題を修正
- [x] 既存日記の検索精度を改善

## バグ修正9
- [x] 既存日記検索が機能していない問題を調査・修正
- [x] デバッグログを確認して根本原因を特定

## バグ修正10
- [x] mergeWithExistingDiary関数のNotion更新API呼び出しを修正（dataパラメータエラー）

## バグ修正11
- [x] 「昨日」などの相対日付指定時にマージが機能しない問題を調査・修正（デバッグログ追加）

## 機能改奣2
- [x] 日本時間（JST）で正しく動作するように日付処理を修正
- [x] 日付の抽出・計算・保存を全てJSTベースに統一

## バグ修正12
- [x] Notionプロパティの「本文」フィールドが更新されない問題を修正
- [x] replace_contentコマンドからupdate_propertiesコマンドに変更

## バグ修正13
- [x] 日本時間（JST）での日付計算が1日ずれている問題を修正
- [x] 「昨日」が正しく前日（1月21日）を指すように修正
- [x] 実際のログから根本原因を特定（findExistingDiaryByDateでUTC日付を使用）
- [x] 全ての日付文字列生成箇所でJST変換を使用するように修正

## バグ修正14
- [x] 箱条書き整形機能が動作していない問題を調査
- [x] 箱条書き整形処理を修正（LLMプロンプトを改善）
- [x] NotionテキストプロパティがMarkdownをサポートしていない問題を確認
- [x] 特殊文字「•」（黒丸）と「◦」（白丸）を使用した箱条書き形式を実装
- [x] 階層化対応（メイン項目とサブ項目）
- [x] 既存のNotionレコードを特殊文字形式に変換

## 機能追加3
- [x] 「食事」タグを追加（Notionデータベーススキーマ、フロントエンド、バックエンド）
- [x] タグの動的管理（Notionデータベースで管理、コードではリストを更新するだけ）
- [x] 追記時のタグマージ機能（新しい内容のタグも既存日記に追加）

## タグ補完タスク
- [x] 既存のNotionレコードを取得し本文とタグを確認
- [x] LLMで本文から適切なタグを推定
- [x] 不足しているタグをNotionに追加（日記 2026/1/21に「食事」と「プライベート」を追加）

## バグ修正15
- [x] 一昨日（1月20日）の日記を更新した際に重複レコードが作成される問題を調査
- [x] 日付検索ロジックのバグを修正（mergeWithExistingDiaryでタグをJSON文字列に変換）
- [x] 重複レコードをマーク（古いレコードに「削除予定」を追加）

## バグ修正16
- [x] 3日前の日記を登録した際のエラーの原因を特定（mergeWithExistingDiaryでpageUrlが空文字列）
- [x] エラーを修正（pageIdからpageUrlを生成）
- [x] テストと検証（全テスト通過）

## バグ修正17
- [x] 修正後も依然とし3日前の日記登録時にエラーが発生する問題を調査
- [x] 新しい原因を特定（saveToNotionでpageUrlが空文字列）
- [x] saveToNotionでpageIdからpageUrlを生成するように修正
- [x] Notion APIレスポンス形式の違いを修正（pages配列からidを取得）
- [ ] 実際のiPhoneでテスト

## バグ修正18
- [x] 既存日記に追記した際に、以前の内容が上書きされて消えてしまう問題を調査
- [x] マージロジックを修正（LLMプロンプトで「既存内容を全て保持」を明確に指示）
- [x] テストと検証（既存196文字からマージ後218文字、内容保持確認）

## 仕様変更1
- [x] 既存日記へのマージ機能を削除（findExistingDiaryByDate、mergeWithExistingDiary関数を削除）
- [x] processRecording関数を修正（常に新しいレコードを作成）
- [x] 同じ日付でも複数のレコードを作成できるように変更
- [x] テストと検証（サーバー起動確認、TypeScriptエラーなし）

## 機能改大3
- [x] formatTextToBulletPoints関数のLLMプロンプトを修正（「昨日の日記に」「3日前の日記に」などのメタ情報を削除）
- [x] 既存のNotionレコードを確認（手動修正を推奨）
- [x] テストと検証（今後の録音でメタ情報が削除されることを確認）

## バグ修正19
- [x] Notion APIからpage_idの抽出に失敗するエラーを調査
- [x] saveToNotion関数のpage_id抽出ロジックを修正（Tool execution result:行からJSONを抽出）
- [x] テストと検証（ユーザーに確認依頼）

## バグ修正20
- [x] iPhoneからの音声録音が失敗するエラーを調査
- [x] エラーの原因を特定（フロントエンドのタイムアウト）
- [x] タイムアウトを120秒に延長
- [x] テストと検証（ユーザーに確認依頼）

## バグ修正21
- [x] 音声変換段階で失敗するエラーを調査
- [x] データベースから最新の録音レコードのエラーメッセージを確認
- [x] エラーの原因を特定（saveToNotion関数の正規表現が改行を考慮していない）
- [x] 正規表現を修正（\nを追加）
- [x] DiaryEntriesコンポーネントにエラーメッセージ表示を追加
- [ ] テストと検証

## リファクタリング1
- [x] saveToNotion関数を完全に書き直す（manus-mcp-cliの出力JSONファイルを直接読み込む方式）
- [x] エラーハンドリングを強化して詳細なログを追加
- [x] 処理の各段階でデータベースに状態を記録（既存の仕組みを利用）
- [x] テストと検証（iPhoneからの録音が成功）

## バグ修正22
- [ ] 公開URL（voicediary-taxagawa.manus.space）からiPhoneでアクセスした際に録音が失敗する問題を調査
- [ ] サーバーログを確認してエラーの原因を特定
- [ ] エラーを修正
- [ ] テストと検証

## タイトル変更
- [x] アプリケーションタイトルを「音声日記」から「AIものぐさ日記」に変更
- [x] フロントエンドのタイトル表示を変更（Home.tsx、index.html）
- [x] 環境変数VITE_APP_TITLEはシステム組み込み変数のためManagement UIから手動変更（コード側は完了）

## バグ修正23
- [x] デプロイ後の日記記録失敗エラーを調査
- [x] サーバーログとデータベースを確認してエラー原因を特定
- [x] 原因分析：公開URLに古いコードがデプロイされている可能性が高い
- [x] 解決方法：Publishボタンで最新のチェックポイントをデプロイ

## 機能追加4
- [x] バージョン確認用APIエンドポイントを実装（/api/trpc/system.version）
- [x] ENV.versionIdをenv.tsに追加
- [x] バージョン確認方法ドキュメントを作成

## バグ修正24
- [x] 公開URLで「音声をテキストに変換中」後の処理失敗エラーを調査
- [x] ログを確認してエラー原因を特定（MCP認証問題の可能性）
- [x] 解決策：Notion REST API直接呼び出し方式に変更

## 機能変更5
- [x] Notion REST API呼び出し関数を実装（server/notion.ts）
- [x] 環境変数NOTION_API_KEYをリクエスト・設定
- [x] 既存のsaveToNotion関数をREST API方式に置き換え
- [x] MCP依存コードを削除（routers.tsからspawnSync呼び出しを削除）
- [x] テストを実装・実行（server/notion.test.ts、全テスト成功）
- [x] データベースIDを正しいものに更新

## 機能追加6
- [x] Notion日付保存をJST（日本標準時）で正確に記録
- [x] 音声変換後にテキスト編集画面を追加（DiaryEditorコンポーネント）
- [x] 編集画面でタイトル、本文、タグ、日付を編集可能に
- [x] 「登録」ボタンでNotionに保存（saveToNotionDiary procedure）
- [x] 音声入力を省略して直接テキスト入力できる機能を追加
- [x] テストと検証（13 tests passed）

## バグ修正25
- [x] Notionの日付カラムが1日ずれて表示される問題を調査
- [x] 日付変換ロジック（DiaryEditor、routers.ts、Home.tsx）を修正
- [x] YYYY-MM-DD文字列を直接送信する方式に変更
- [x] 音声内容に関わらず、デフォルトを今日の日付に設定
- [x] テストと検証

## 仕様変更7
- [x] extractMetadataで音声内容から日付抽出機能を再有効化
- [x] 日付フィールドは常に今日の日付（録音した日）に固定
- [x] タイトルの日付は音声から抽出した日付を使用
- [x] 音声に日付指定がなければタイトルも今日の日付を使用
- [x] DiaryEditorで日付フィールドを読み取り専用に変更
- [x] テストと検証

## 機能改善8
- [x] extractMetadataのプロンプトを改善
- [x] 「〇〇の日記に記録」指示と実際の日記内容を区別
- [x] 例：「昨日の日記に今日は雨だったと記録」→タイトル：昨日、本文：今日は雨だった
- [x] テストと検証

## 機能追加9
- [x] Notionから日記データを取得するAPI実装（日付範囲指定、タイトル検索）
- [x] 同一タイトルレコードのマージ機能実装
  - [x] 同じタイトルの複数レコードを検出
  - [x] 内容をマージして一つのレコードにまとめる
  - [x] タグは各レコードのORを取る
  - [x] 残りの同じタイトルのレコードを削除
- [x] カレンダーUIコンポーネント実装（テキスト直接入力ボタンの下に表示）
- [x] 日付クリック時の日記参照機能実装
- [x] テストと検証

## バグ修正10
- [x] 日記検索のAPI呼び出しエラーを修正
- [x] カレンダーの日付クリック時のエラーハンドリング改善

## 機能追加11
- [x] 月別の日記データを取得する機能実装
- [x] カレンダーに日記の有無を色分け表示（登録あり：色付き、登録なし：グレーアウト）
- [x] 登録されていない日のクリックを無効化
- [x] ポップアップ（ダイアログ）で日記内容を表示する機能実装
- [x] テストと検証

## バグ修正12
- [x] useEffectの無限ループエラーを修正（onMonthChange依存配列の問題）

## バグ修正13
- [x] カレンダーで1月19日から22日がクリックできない問題を調査
- [x] 日記データの日付フォーマットとカレンダーの日付フォーマットの不一致を修正

## バグ修正14
- [x] タイムゾーンのずれを修正（UTC→JSTの変換が正しく行われていない）
- [x] カレンダーの日付とNotionのタイトル日付を一致させる
