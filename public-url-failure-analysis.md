# 公開URLでの日記登録失敗の技術的要因分析

## 実施日時
2026年1月23日

## 問題の概要
- **症状**: 公開URL（voicediary-taxagawa.manus.space）で日記の録音・登録が失敗する
- **開発URL**: 正常に動作（https://3000-iqfftk8yiv3jrubjrixxv-59b763ca.sg1.manus.computer）
- **録音時間**: 数秒程度の短い録音
- **エラーメッセージ**: 「登録に失敗しました」（詳細不明）

## 分析結果

### 1. デプロイバージョンの不一致（最も可能性が高い）

**問題**: 公開URLに最新のコード（チェックポイントd8f4376e）がデプロイされていない

**根拠**:
- 開発URLでは最新コード（bee0f0f4以降のリファクタリング版）が正常動作
- 公開URLは古いバージョン（おそらくbee0f0f4以前）を実行している可能性
- 過去のチェックポイント（bee0f0f4）では、saveToNotion関数が正規表現ベースのパース方式を使用しており、不安定だった

**影響**:
- 古いコードでは、manus-mcp-cliの出力パースが失敗する可能性が高い
- 特に改行を含む出力で正規表現マッチが失敗し、page_id抽出に失敗する

**解決方法**: 最新のチェックポイント（d8f4376e）をPublishボタンでデプロイ

---

### 2. MCP統合の環境依存性（可能性: 中）

**問題**: 公開環境でmanus-mcp-cliの実行環境が異なる可能性

**根拠**:
- コードはspawnSync()でmanus-mcp-cliコマンドを直接実行している
- 開発環境では`/usr/local/bin/manus-mcp-cli`が利用可能
- 公開環境でのPATH設定やコマンドの利用可能性が不明

**潜在的な問題**:
```typescript
// server/routers.ts:450-454
const spawnResult = spawnSync(
  'manus-mcp-cli',
  ['tool', 'call', 'notion-create-pages', '--server', 'notion', '--input', JSON.stringify(notionInput)],
  { encoding: 'utf-8' }
);
```

**影響**:
- 公開環境でmanus-mcp-cliが見つからない場合、spawnSync()が失敗
- エラーハンドリングは実装されているが、ユーザーには「登録に失敗しました」と表示される

**確認方法**: 公開環境のサーバーログを確認（現在アクセス不可）

---

### 3. Notion MCP認証の環境差異（可能性: 低）

**問題**: 開発環境と公開環境でNotion MCP認証が異なる可能性

**根拠**:
- MCP設定は`~/.mcp/servers.json`に保存されている
- 開発環境: `{"notion": "9c27c684-2f4f-4d33-8fcf-51664ea15c00"}`
- 公開環境の設定は不明

**影響**:
- 公開環境でNotion MCPが未認証の場合、notion-create-pagesツールの実行が失敗
- OAuth認証が必要な場合、サーバーサイドでは自動認証できない

**確認方法**: 公開環境でMCP認証状態を確認

---

### 4. 環境変数の不一致（可能性: 低）

**問題**: 公開環境で必要な環境変数が設定されていない可能性

**必要な環境変数**:
- `BUILT_IN_FORGE_API_URL`: Whisper API（音声変換）に必要
- `BUILT_IN_FORGE_API_KEY`: Whisper API認証に必要
- その他のシステム環境変数（JWT_SECRET、OAUTH_SERVER_URLなど）

**根拠**:
- これらの環境変数はManusプラットフォームが自動的に注入する
- 開発環境と公開環境で同じ値が使用されるはず

**影響**:
- 環境変数が欠けている場合、音声変換段階で失敗
- ただし、エラーメッセージから判断すると、音声変換ではなくNotion保存段階で失敗している可能性が高い

---

### 5. タイムアウト設定（可能性: 低）

**問題**: 公開環境でのタイムアウト設定が厳しい可能性

**根拠**:
- フロントエンドのtRPCクライアントは120秒のタイムアウトを設定済み
- 処理フロー: 音声アップロード（数秒）→ Whisper変換（10-30秒）→ LLM処理（5-10秒）→ Notion保存（5-10秒）
- 合計で最大60秒程度

**影響**:
- 公開環境でサーバー側のタイムアウトが短い場合、処理が途中で中断される
- ただし、数秒の録音であれば処理時間は短いはず

---

## 結論と推奨事項

### 主要な原因（確率: 90%）
**デプロイバージョンの不一致**: 公開URLに古いコード（bee0f0f4以前）がデプロイされており、saveToNotion関数の正規表現ベースのパースが失敗している

### 推奨される対応手順

1. **即座に実施すべき対応**:
   - Management UIから最新のチェックポイント（d8f4376e）をPublishボタンでデプロイ
   - デプロイ後、公開URLで短い録音をテストして動作確認

2. **デプロイ後も失敗する場合の追加調査**:
   - 公開環境のサーバーログを確認（Manusサポートに問い合わせ）
   - manus-mcp-cliの実行状態を確認
   - Notion MCP認証状態を確認

3. **長期的な改善策**:
   - エラーメッセージの詳細化（どの段階で失敗したかを明確に表示）
   - 公開環境専用のヘルスチェックエンドポイントを追加
   - MCP統合の代替手段（REST API直接呼び出し）を検討

---

## 技術的な補足情報

### 現在のsaveToNotion実装（チェックポイントd8f4376e）
- JSONファイルを直接読み込む安定した方式
- エラーハンドリングが強化されている
- 開発環境で正常動作を確認済み

### 過去のsaveToNotion実装（チェックポイントbee0f0f4以前）
- 正規表現でstdoutをパースする不安定な方式
- 改行を含む出力でマッチ失敗の可能性が高い
- 公開URLがこのバージョンの場合、失敗は予想される動作

### コードの互換性
- 現在のコードは開発環境と公開環境の両方で動作するように設計されている
- 外部依存: manus-mcp-cli、Notion MCP、Whisper API
- すべての依存関係はManusプラットフォームが提供するため、環境差異は最小限のはず
